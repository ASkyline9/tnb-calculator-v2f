<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TNB Electricity Cost Calculator</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="assets/favicon-32x32.png" sizes="32x32">
</head>
<body>
    <div class="app-container">
        <header>
            <img src="assets/favicon-64x64.png" alt="TNB Logo" class="logo">
            <h1>TNB Electricity Cost Calculator</h1>
            <p class="subtitle">Quickly Calculate Your Electricity Cost in Malaysia</p>
        </header>

        <main>
            <div class="card">
                <form id="calcForm">
                    <div class="form-group">
                        <label for="amp">Current</label>
                        <div class="input-wrapper">
                            <input type="number" step="0.01" id="amp" placeholder="e.g. 6.8" required>
                            <span>Amps</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="voltage">Voltage</label>
                        <div class="input-wrapper">
                            <input type="number" step="1" id="voltage" value="240" required>
                            <span>Volts</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="minutes">Usage Duration</label>
                        <div class="input-wrapper">
                            <input type="number" step="1" id="minutes" placeholder="e.g. 45" required>
                            <span>Minutes</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="rate">TNB Rate (RM0.27 July 2025)</label>
                        <div class="input-wrapper">
                            <input type="number" step="0.001" id="rate" value="0.27" required>
                            <span>RM/kWh</span>
                        </div>
                    </div>
                    <button type="submit" class="btn">Calculate Cost</button>
                </form>
            </div>

            <div class="card result-box hidden" id="resultBox">
                <p id="resultText"></p>
            </div>
            
            <div class="card history">
                <h2>Calculation History</h2>
                <div class="table-container">
                    <table id="historyTable">
                        <thead>
                            <tr>
                                <th>Amp</th>
                                <th>Mins</th>
                                <th>Rate</th>
                                <th>Volt</th>
                                <th>Cost (RM)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="history-buttons">
                    <button id="clearHistoryBtn">Clear History</button>
                </div>
            </div>

            <a href="https://s.shopee.com.my/4L9U1n1WuH" target="_blank" style="text-decoration: none;">
                <div style="background-color: #EE4D2D; color: white; padding: 15px; text-align: center; border-radius: 8px; margin-top: 20px; font-weight: bold; font-size: 1.1em;">
                    Appliances Tester (Current Measurement) on Shopee
                </div>
            </a>
        </main>

        <footer>
            <div class="footer-links">
                <a href="https://github.com/askyline9/tnb-calculator-v2f/blob/main/README.md" target="_blank" rel="noopener noreferrer" class="footer-link">About This App</a>
            </div>
            <button id="installBtn" class="hidden">Install App</button>
            <p class="dev-info">Developed by <a href="https://askyline9.github.io" target="_blank">Skyline Hub</a></p>
            <p>Assisted by Deepseek</p>
            <p>&copy; 2025 Version 2.0.0 | 21 August 2025</p>
            <a href="https://askyline9.github.io/petrol-calculator-v2/" target="_blank" rel="noopener noreferrer" class="footer-link petrol-link"><strong>Petrol Usage Calculator</strong></a>
            <p>All Rights Reserved</p>
        </footer>
    </div>

    <!-- Notification Toast -->
    <div id="notificationToast" style="display: none; position: fixed; bottom: 20px; right: 20px; background: #4CAF50; color: white; padding: 12px; border-radius: 4px; z-index: 1000;">
        Sending notification...
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('calcForm');
            const resultBox = document.getElementById('resultBox');
            const resultText = document.getElementById('resultText');
            const historyTable = document.querySelector('#historyTable tbody');
            const clearHistoryBtn = document.getElementById('clearHistoryBtn');
            const installBtn = document.getElementById('installBtn');
            const MAX_HISTORY = 10;

            // Calculator logic
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const amp = parseFloat(document.getElementById('amp').value);
                const minutes = parseFloat(document.getElementById('minutes').value);
                const rate = parseFloat(document.getElementById('rate').value);
                const voltage = parseFloat(document.getElementById('voltage').value);

                if (isNaN(amp) || isNaN(minutes) || isNaN(rate) || isNaN(voltage)) {
                    resultText.innerHTML = `<span style="color:red;">Please fill in all fields with valid numbers.</span>`;
                    resultBox.classList.remove('hidden');
                    return;
                }

                const powerKw = (amp * voltage) / 1000;
                const hours = minutes / 60;
                const cost = powerKw * hours * rate;

                resultText.innerHTML = `Estimated Cost: <strong>RM ${cost.toFixed(2)}</strong>`;
                resultBox.classList.remove('hidden');
                resultBox.scrollIntoView({ behavior: 'smooth' });

                addToHistory(amp, minutes, rate, voltage, cost);
            });

            function addToHistory(amp, minutes, rate, voltage, cost) {
                const history = JSON.parse(localStorage.getItem('calcHistory')) || [];
                const newEntry = { amp, minutes, rate, voltage, cost: cost.toFixed(2) };
                
                // Add the new entry to the start of the array
                history.unshift(newEntry);
                
                // Keep only the 10 most recent entries
                if (history.length > MAX_HISTORY) {
                    history.pop();
                }

                localStorage.setItem('calcHistory', JSON.stringify(history));
                renderHistory();
            }

            function renderHistory() {
                const history = JSON.parse(localStorage.getItem('calcHistory')) || [];
                historyTable.innerHTML = ''; // Clear the current table

                history.forEach(entry => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${entry.amp}</td>
                        <td>${entry.minutes}</td>
                        <td>${entry.rate}</td>
                        <td>${entry.voltage}</td>
                        <td><strong>${entry.cost}</strong></td>
                    `;
                    historyTable.appendChild(row);
                });
            }

            function clearHistory() {
                localStorage.removeItem('calcHistory');
                renderHistory();
            }

            clearHistoryBtn.addEventListener('click', clearHistory);
            
            // PWA Install Button logic
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                installBtn.classList.remove('hidden');
            });

            installBtn.addEventListener('click', () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then(() => {
                        deferredPrompt = null;
                        installBtn.classList.add('hidden');
                    });
                }
            });

            // Load history on initial page load
            renderHistory();
            
            // Initialize EmailJS and send notification AFTER DOM is fully loaded
            initializeEmailAndSendNotification();
        });

        // Initialize EmailJS with your Public Key
        function initializeEmailAndSendNotification() {
            // Check if emailjs is available
            if (typeof emailjs === 'undefined') {
                console.error('EmailJS is not loaded');
                return;
            }
            
            emailjs.init("u8q8lvRWe9DBYUXRt");
            console.log('TNB Cal loaded successfully');
            
            // Show notification toast
            const toast = document.getElementById('notificationToast');
            if (toast) {
                toast.style.display = 'block';
                
                // Send visit notification
                sendVisitNotification();
                
                // Hide toast after 5 seconds
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 5000);
            }
        }
        
        // Function to get visitor's IP address
        async function getVisitorIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.log('Error fetching IP:', error);
                return 'Unable to detect';
            }
        }

        // Function to send visit notification
        async function sendVisitNotification() {
            // Get visitor information
            const page = "https://askyline9.github.io/tnb-calculator-v2f/";
            const referrer = document.referrer || 'Direct visit';
            const time = new Date();
            const userAgent = navigator.userAgent;
            const screenResolution = `${window.screen.width}x${window.screen.height}`;
            const language = navigator.language || navigator.userLanguage;
            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const ipAddress = await getVisitorIP();
            
            // Format the time in a more readable way
            const formattedTime = time.toLocaleString('en-MY', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });
            
            // Get the page title
            const pageTitle = document.title;
            
            // Detect if visitor is likely a bot
            const isLikelyBot = /bot|crawl|spider|slurp|teoma|archive|track|screenshot|monitoring|data|fetch|java|curl|wget|python|php|ruby|perl|go|node|libwww/i.test(userAgent);
            
            // Prepare detailed email content
            const emailContent = `
üåê NEW VISITOR ON TNB Calculator üåê

üìÑ Page Visited: ${pageTitle}
üîó URL: ${page}
üåê IP Address: ${ipAddress}

‚è∞ Visit Time: ${formattedTime}
üó∫Ô∏è Timezone: ${timezone}

üìç Referral Source: ${referrer}
üåê Language: ${language}

üíª Device Information:
- User Agent: ${userAgent}
- Screen Resolution: ${screenResolution}
- ${isLikelyBot ? 'ü§ñ Likely Bot/Crawler' : 'üë§ Likely Human Visitor'}

---
This notification was sent automatically from your TNB Calculator website.
            `;
            
            // Prepare template parameters
               const templateParams = {
                to_email: 'aa.skyline99@gmail.com',
                from_name: 'TNB Cal Visitor Alert',
                message: emailContent,
                reply_to: 'noreply@skylinehub.com',
                subject: 'New Visitor TNB Calculator',
                website: 'TNB Calculator',
                ip_address: ipAddress,
                email_subject: 'New Visitor TNB Calculator',
                title: 'New Visitor TNB Calculator'
            };
            
            // Send email using EmailJS
            emailjs.send('service_cc9cmen', 'template_kel4u0e', templateParams)
                .then(function(response) {
                    console.log('Notification sent successfully!', response.status, response.text);
                    const toast = document.getElementById('notificationToast');
                    if (toast) {
                        toast.textContent = 'Notification sent successfully!';
                    }
                }, function(error) {
                    console.log('Failed to send notification.', error);
                    const toast = document.getElementById('notificationToast');
                    if (toast) {
                        toast.textContent = 'Notification failed. Check console.';
                        toast.style.background = '#e74c3c';
                    }
                });
        }
    </script>
    
    <!-- Load EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3.2.0/dist/email.min.js"></script>
</body>
</html>